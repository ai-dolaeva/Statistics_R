---
title: "Практика №5. Многомерные методы"
author: "Долаева А. Р., г.20.М04-мм"
date: "13/05/2021"
output: 
    pdf_document:
        latex_engine: xelatex
keep_tex: true        
header-includes:
   - \XeTeXdefaultencoding cp1251
   - \usepackage{xltxtra}
   - \usepackage{fontspec}
   - \setmainfont{Times New Roman}
   - \newfontfamily{\cyrillicfont}{Times New Roman}
   - \usepackage[english,russian]{babel}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library('MASS')
library('knitr')
library("survival")
library(GGally)
```

### Вариант №3.  
  
|     X1    |      X2     |   X3  |  X4  |  X5  |   X6  |
|-----------|:-----------:|------:|-----:|-----:|------:|
| insomia.1 | anoreksia.1 | SBP.1 | SV.1 | CO.1 | TPR.1 |
  

Данные на первый день исследования:  
insomia - бессонница, категориальный признак (0,1,2)  
anoreksia - анорексия,категориальный (0,1,2)  
SBP - систолическое артериальное давление, метрический  
SV - ударный объем крови, метрический  
CO - сердечный выброс, метрический  
TPR - общее периферическое (сосудистое) сопротивление, метрический.

#### 1. Факторный анализ. Найти наиболее значимые главные компоненты, построить факторные нагрузки, проинтерпретировать факторы, построить двумерные диаграммы факторов.

---  

Читаем данные:
```{r}
data <- read.table(file = "data.csv", header = TRUE, sep = ",")
X<-na.omit(data[,c("insomia.1", "anoreksia.1", "SBP.1", "SV.1", "CO.1", "TPR.1")])
```

Построим попарные диаграммы рассеяния:
```{r ev='cairo_pdf', out.width='60%', out.height='50%', fig.align="center"}
ggpairs(X)
```

Из графиков можем предположить, что SV.1 и CO.1 положительно скоррелированы между собой, а TPR.1 отрицательно с SV.1 и CO.1.  
Очевидно, что ударный объем крови (SV), сердечный выброс (CO) и общее периферическое сопротивление (TPR) связаны друг с другом.

---  

Применяем метод главных компонент, и выводим вклады компонент:
```{r}
pc<-princomp(scale(X))
pc$sdev/sum(pc$sdev)
```

Так 31% информации содержит первая компонента, 21% вторая, 17% третья.  
Сумма первых стрех компонет 72%

```{r}
sum(pc$loading[,seq(3)])
```

Можно выбрать первые 2 компонета, которые дают более 50% информации. Мы отберем первые 3, выведем матрицу, показывающую, как связаны параметры с главными компонентами:

```{r}
pc$loading[,seq(3)]
```

Первая компонента отвечает за SV, CO, TPR и в целом несет информацию о состоянии сердца: низкие ударный объем крови и сердечный выброс, высокое общее периферическое сопротивление.  
Вторая связана с высокой бессоницей (insomia) и пониженным систолическим артериальным давлением (SBP), Эта компонента характеризуется состоянием нервной системы.  
Третья с высокой бессоницей (insomia) и аноксией (anoreksia), и сообщает о состоянии здоровья со стороны пищеварительной системы.

---  

Строим графики рассеивания и оцениваем разброс по компонентам:
```{r ev='cairo_pdf', out.width='80%', out.height='60%', fig.align="center"}
op<-par(mfrow=c(2,2))
plot(pc$scores[,1],pc$scores[,2],type="n",xlab="f1", ylab="f2")
text(pc$scores[,1],pc$scores[,2],row.names(X),cex=0.7)
plot(pc$scores[,1],pc$scores[,3],type="n", xlab="f1",ylab="f3")
text(pc$scores[,1],pc$scores[,3],row.names(X),cex=0.7)
plot(pc$scores[,2],pc$scores[,3],type="n",xlab="f2",ylab="f3")
text(pc$scores[,2],pc$scores[,3],row.names(X),cex=0.7)
par(op)
```

Из первого графика по первой и второй компонентам: индивиды, находящиеся близко к левой границе (2), характеризуются высокими ударным объемом крови и сердечным выбросом, низким общим периферическим сопротивлением. У 26 индивида противоположные показатели. Индивидам, близким к нижней границе (6), свойствены низкий уровень бессоницы и повышенное систолические артериальное давление. И наоборот, для тех, ко находится ближе к верхней границе.  

Из второго графика по первой и третьей компонентам: индивиды, находящиеся близко к левой границе (2), характеризуются высокими ударным объемом крови и сердечным выбросом, низким общим периферическим сопротивлением. У 26 индивида противоположные показатели. Индивидов, близкие к нижней границе, отличает низкие уровни бессоницы и аноксии. И наоборот, для тех, ко находится ближе к верхней границе.  

Из третьего графика по второй и третьей компонентам: индивиды, находящиеся близко к левой границе (6), характеризуются низким уровнем бессоницы и повышенным систолические артериальным давлением. У 23 индивида противоположные показатели. Индивидам, близким к нижней границе (6), свойствены низкие уровни бессоницы и аноксии. И наоборот, для тех, ко находится ближе к верхней границе.  


```{r ev='cairo_pdf', out.width='60%', out.height='50%', fig.align="center"}

op<-par(mfrow=c(1,2))

plot(pc$scores[,2],pc$scores[,3],type="n",xlab="f1", ylab="f3")

for(i in c(0,1,2))
  lines(pc$scores[X$anoreksia.1==i,1],pc$scores[X$anoreksia.1==i,2],
        type="p",pch=20,col=i+1)
legend('bottomright',c("anoreksia=0","anoreksia=1","anoreksia=2"),
       cex=0.5,pch=20,col=seq(3))

plot(pc$scores[,2],pc$scores[,3],type="n",xlab="f1", ylab="f3")

for(i in c(0,1,2))
  lines(pc$scores[ X$insomia.1==i,1],pc$scores[X$insomia.1==i,2],
        type="p",pch=20,col=i+4)

legend('bottomright',c( "insomia=0","insomia=1", "insomia=2"),
       cex=0.5,pch=20,col=seq(3)+3)

```

#### 2. Дискриминантный анализ. Найти дискриминантные функции, их веса, построить матрицу классификации (оценить чувствительность, специфичность, вероятность правильной классификации).

---  

Объединяем признаки 0 и 1 в таблицах:
```{r}
table(X$insomia.1)
table(X$anoreksia.1)
Group<-ifelse(X$insomia.1==2,1,0)
Group.<-ifelse(X$anoreksia.1==2,1,0)
```

Применяем линейный дискриминантный анализ и выводим коэффициенты (веса) для метрических переменных:
```{r}
LDA<-lda(Group~.,subset(cbind(X,Group=Group),select=-c(insomia.1,anoreksia.1)))
LDA$scaling
```

Матрица классификации:
```{r}
tab<-table(Group,predict(LDA,X)$class);tab
```
Оценим чувствительность и специфичность для предсказанных категорий фактора insomia.1:
```{r}
round(tab[1,1]/sum(tab[,1])*100)
round(tab[2,2]/sum(tab[,2])*100)
```
чувствительность равна 69%, процент предсказанных нулей.
специфичность равна 65%, процент предсказанных единиц.


Оценим вероятность правильной классификации для предсказанных категорий фактора insomia.1:
```{r}
Prob<-sum(diag(tab))/sum(sum(tab));Prob
```
Высокий показатель: 67% правильной классификации.

--- 

Значения дискриминантной функции:
```{r}
P1<-predict(LDA,X)$x
LDA<-lda(Group~.,subset(cbind(X,Group=Group.),select=-c(insomia.1,anoreksia.1)))
LDA$scaling
```

```{r}
tab<-table(Group,predict(LDA,X)$class);tab
```
Оценим чувствительность и специфичность для предсказанных категорий фактора anoreksia.1:
```{r}
round(tab[1,1]/sum(tab[,1])*100)
round(tab[2,2]/sum(tab[,2])*100)
```

```{r}
Prob<-sum(diag(tab))/sum(sum(tab));Prob
```
Невысокий показатель: 40% правильной классификации.

Значения дискриминантной функции:
```{r}
P2<-predict(LDA,X)$x
cbind(P1=P1,P2=P2,Group=Group,Group.=Group.)
```


Классификация по двум факторам:  
красная точка - предсказанные значения низкой бессоницы индивидам;  
зеленая точка - предсказанные значения высокой бессоницы индивидам;  
черная окружность - предсказанные значения низкой анорексии индивидам;  
голубая окружность - предсказанные значения высокой анорексии индивидам. 

```{r ev='cairo_pdf', out.width='70%', out.height='50%', fig.align="center"}
plot(P1,P2,type="n")
lines(P1[Group==0],P2[Group==0],type="p",pch=20,col=2)
lines(P1[Group==1],P2[Group==1],type="p",pch=20,col=3)
legend('topright',c("insomx<2","insom=2"),pch=1,col=c(2,3))
lines(P1[Group.==0],P2[Group.==0],type="p",pch=1,col=1,cex=2)
lines(P1[Group.==1],P2[Group.==1],type="p",pch=1,col=5,cex=2)
legend('bottomleft',c("anorex<2","anorex=2"),pch=1,col=c(1,5))
```


